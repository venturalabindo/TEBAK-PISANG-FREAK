<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TEBAK PISANG NGEHE üçåüî•</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Comic+Neue:wght@700&family=Permanent+Marker&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { 
            --cup-width: 90px; 
            --speed: 0.4s;
        }
        @media (min-width: 768px) { :root { --cup-width: 140px; } }

        body {
            background-color: #ffccff;
            background-image: url("https://img.sanishtech.com/u/669af3d62b957042e76eb70a34406d71.png"); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
            margin: 0;
            font-family: 'Comic Neue', cursive;
            overflow-x: hidden;
            color: #000;
            touch-action: manipulation;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.15); 
            z-index: -1;
        }

        .freak-title {
            font-family: 'Bungee', cursive;
            color: #ffff00;
            -webkit-text-stroke: 2px #000;
            text-shadow: 6px 6px 0px #ff0000;
            transform: rotate(-2deg);
            line-height: 1.2;
        }

        .ngehe-font {
            font-family: 'Permanent Marker', cursive;
        }

        .main-wrapper {
            position: relative;
            min-height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .game-container {
            position: relative;
            height: 220px;
            width: 100%;
            max-width: 600px;
            margin: 30px auto;
            z-index: 40;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 8px solid #000;
            box-shadow: 15px 15px 0px rgba(0,0,0,0.6);
        }

        .cup-wrapper {
            position: absolute;
            bottom: 10px;
            width: var(--cup-width);
            transition: left var(--speed) cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translateX(-50%);
        }

        .cup {
            width: 100%;
            height: 110px;
            background-image: url('https://image2url.com/r2/default/images/1768992209991-02db9915-a866-47bf-85b3-57526d208b01.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            cursor: pointer;
            z-index: 50;
            transition: transform 0.2s ease;
            filter: drop-shadow(5px 5px 0px #000);
        }

        @media (min-width: 768px) { .cup { height: 140px; } }

        .cup.lifted { transform: translateY(-130px) scale(1.3) rotate(15deg); }

        .banana {
            position: absolute;
            bottom: 15px;
            font-size: 3.5rem;
            z-index: 45;
            opacity: 0;
            transition: opacity 0.1s;
        }

        .banana.visible { opacity: 1; }

        .freak-bubble {
            background: #ffff00;
            border: 4px solid #000;
            padding: 10px 15px;
            box-shadow: 8px 8px 0px #000;
            max-width: 250px;
            text-align: center;
            position: relative;
            transform: skew(-3deg);
        }

        .btn-ngehe {
            background: #22c55e;
            border: 6px solid #000;
            color: white;
            padding: 15px 30px;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 10px 10px 0px #000;
        }

        .btn-ngehe:active {
            transform: translate(4px, 4px);
            box-shadow: 6px 6px 0px #000;
        }
    </style>
</head>

<body>
    <!-- Login Box -->
    <div id="login-box" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[5000] p-4">
        <div class="bg-white border-[10px] border-black p-8 text-center shadow-[20px_20px_0px_#ff00ff] max-w-sm w-full">
            <div class="text-7xl mb-4 animate-bounce">üëã</div>
            <h2 class="text-4xl font-black mb-6 ngehe-font italic uppercase underline text-black">KENALAN DULU DONG!</h2>
            <input type="text" id="player-name-input" maxlength="15" placeholder="Nama lo siapa..." class="w-full p-4 bg-yellow-100 border-4 border-black mb-6 text-xl font-bold text-center outline-none focus:bg-cyan-300">
            <button onclick="savePlayerName()" class="w-full bg-blue-500 text-white font-black py-5 border-4 border-black shadow-[8px_8px_0px_#000] text-xl uppercase transition-all active:translate-y-2 active:shadow-none">GAS MAEN!</button>
        </div>
    </div>

    <div class="main-wrapper">
        <header class="text-center mb-4 relative z-50">
            <h1 class="text-5xl md:text-7xl freak-title mb-6">PISANG NGEHE!</h1>
            
            <div class="flex flex-col items-center min-h-[100px] mb-4">
                <div id="ai-comment-box" class="freak-bubble hidden">
                    <span class="text-[10px] font-black block border-b-2 border-black mb-1">BESTIE FREAK</span>
                    <p id="ai-text" class="italic text-sm font-bold uppercase">"SEMANGAT YA BESTIE!"</p>
                </div>
            </div>

            <div class="flex items-center justify-center gap-3">
                <div class="bg-white border-4 border-black px-4 py-1 font-black text-sm shadow-[6px_6px_0px_#000]">SKOR: <span id="score">0</span></div>
                <div class="bg-white border-4 border-black px-4 py-1 font-black text-sm shadow-[6px_6px_0px_#000]">LVL: <span id="level">1</span></div>
                <button onclick="toggleLeaderboard()" class="bg-cyan-400 border-4 border-black px-4 py-1 font-black text-sm shadow-[6px_6px_0px_#000]">üèÜ TOP SKOR</button>
            </div>
        </header>

        <main class="game-container" id="game-board">
            <div class="cup-wrapper" id="wrapper-0" style="left: 15%;">
                <div class="banana" id="banana-0">üçå</div>
                <div class="cup" onclick="handleCupClick(0)"></div>
            </div>
            <div class="cup-wrapper" id="wrapper-1" style="left: 50%;">
                <div class="banana" id="banana-1">üçå</div>
                <div class="cup" onclick="handleCupClick(1)"></div>
            </div>
            <div class="cup-wrapper" id="wrapper-2" style="left: 85%;">
                <div class="banana" id="banana-2">üçå</div>
                <div class="cup" onclick="handleCupClick(2)"></div>
            </div>
        </main>

        <footer class="mt-8 relative z-50">
            <button id="start-btn" class="btn-ngehe text-2xl" onclick="startSequence()">
                KOCAK-IN MAS!
            </button>
        </footer>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-box" class="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center hidden z-[6000] p-4">
        <div class="bg-white border-[10px] border-black p-6 shadow-[25px_25px_0px_#ff00ff] w-full max-w-sm flex flex-col max-h-[85vh]">
            <h2 class="text-3xl font-black mb-6 text-center italic uppercase ngehe-font underline">üèÜ PARA PRO FREAK üèÜ</h2>
            <div id="leaderboard-list" class="flex-1 overflow-y-auto mb-4 space-y-3 pr-2 text-black"></div>
            <button onclick="toggleLeaderboard()" class="w-full bg-red-500 text-white border-4 border-black font-black py-4 uppercase text-xl">TUTUP</button>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-box" class="fixed inset-0 bg-yellow-400/95 flex items-center justify-center hidden z-[7000] p-4">
        <div class="bg-white p-10 border-[12px] border-black text-center max-w-sm w-full shadow-[20px_20px_0px_#000]">
            <div id="modal-icon" class="text-8xl mb-6"></div>
            <h2 id="modal-title" class="text-4xl font-black mb-4 ngehe-font uppercase italic text-black"></h2>
            <p id="modal-text" class="text-xl font-bold mb-10 text-blue-600"></p>
            <button onclick="closeModal()" class="w-full bg-green-500 border-4 border-black py-5 font-black uppercase text-2xl active:translate-y-2 active:shadow-none">GAS LAGI!</button>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let db, auth, user, playerName = "";
        let score = 0, level = 1, isMoving = false, canInteract = false;
        let bananaAtWrapper = 1, positions = [15, 50, 85], cupMapping = [0, 1, 2];

        async function initGame() {
            try {
                if (typeof __firebase_config === 'undefined') return;
                const config = JSON.parse(__firebase_config);
                firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }

                auth.onAuthStateChanged(u => {
                    user = u;
                    if (user) loadLeaderboard();
                });
            } catch (e) { console.error(e); }
        }

        async function callFreakAI(context) {
            const aiBox = document.getElementById('ai-comment-box');
            const aiText = document.getElementById('ai-text');
            try {
                // System prompt diubah agar lebih ramah dan suportif
                const prompt = `Pemain: ${playerName}, Skor: ${score}, Level: ${level}, Konteks: ${context}. 
                Berperanlah sebagai 'BESTIE FREAK' yang asyik, kocak, nyeleneh tapi suportif. 
                Gunakan bahasa gaul Jakarta. JANGAN menghina atau merendahkan pemain. 
                Berikan semangat atau komentar lucu yang mendukung. Maks 10 kata.`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Yok bisa yok bestie!";
                aiText.innerText = `"${reply.trim()}"`;
                aiBox.classList.remove('hidden');
            } catch (e) { aiBox.classList.add('hidden'); }
        }

        window.savePlayerName = () => {
            const input = document.getElementById('player-name-input');
            if (!input.value.trim()) return;
            playerName = input.value.trim();
            document.getElementById('login-box').classList.add('hidden');
            callFreakAI("Mulai masuk game");
        };

        window.startSequence = async () => {
            if (isMoving) return;
            isMoving = true; canInteract = false;
            document.getElementById('start-btn').disabled = true;
            
            document.querySelectorAll('.banana, .cup').forEach(el => el.classList.remove('visible', 'lifted'));
            bananaAtWrapper = Math.floor(Math.random() * 3);
            
            const activeCup = document.querySelector(`#wrapper-${bananaAtWrapper} .cup`);
            const activeBanana = document.querySelector(`#wrapper-${bananaAtWrapper} .banana`);
            
            activeBanana.classList.add('visible');
            activeCup.classList.add('lifted');
            
            await new Promise(r => setTimeout(r, 600));
            activeCup.classList.remove('lifted');
            await new Promise(r => setTimeout(r, 400));
            activeBanana.classList.remove('visible');

            const startSpeed = 0.4;
            const endSpeed = 0.05;
            const speed = Math.max(endSpeed, startSpeed - ((level - 1) * (startSpeed - endSpeed) / 99));
            
            const startShuffles = 8;
            const endShuffles = 50;
            const count = Math.min(endShuffles, Math.floor(startShuffles + ((level - 1) * (endShuffles - startShuffles) / 99)));

            document.documentElement.style.setProperty('--speed', `${speed}s`);
            
            for (let i = 0; i < count; i++) {
                let p1 = Math.floor(Math.random() * 3), p2 = Math.floor(Math.random() * 3);
                while (p1 === p2) p2 = Math.floor(Math.random() * 3);
                
                [cupMapping[p1], cupMapping[p2]] = [cupMapping[p2], cupMapping[p1]];
                cupMapping.forEach((wIdx, posIdx) => {
                    document.getElementById(`wrapper-${wIdx}`).style.left = `${positions[posIdx]}%`;
                });
                await new Promise(r => setTimeout(r, speed * 1000));
            }
            isMoving = false; canInteract = true;
            document.getElementById('start-btn').disabled = false;
        };

        window.handleCupClick = async (idx) => {
            if (!canInteract) return;
            canInteract = false;
            
            const clickedCup = document.querySelector(`#wrapper-${idx} .cup`);
            clickedCup.classList.add('lifted');
            
            if (idx === bananaAtWrapper) {
                score++; 
                if(level < 100) level++;
                
                document.getElementById(`banana-${idx}`).classList.add('visible');
                updateHighScore();
                callFreakAI("Menang");
                setTimeout(() => showModal("KEREN!", `Gila sih, mata lo tajem banget! Skor: ${score} | Lvl: ${level}`, "üî•"), 500);
            } else {
                const finalScore = score;
                const finalLevel = level;
                document.querySelector(`#wrapper-${bananaAtWrapper} .cup`).classList.add('lifted');
                document.getElementById(`banana-${bananaAtWrapper}`).classList.add('visible');
                
                score = 0; level = 1;
                callFreakAI("Kalah");
                setTimeout(() => showModal("NYARIS!", `Dikit lagi tadi! Skor: ${finalScore} | Lvl Mentok: ${finalLevel}. Semangat lagi!`, "üåà"), 500);
            }
            document.getElementById('score').innerText = score;
            document.getElementById('level').innerText = level;
        };

        async function updateHighScore() {
            if (!db || !user || score === 0) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'tebak-pisang-freak';
            await db.doc(`/artifacts/${appId}/public/data/leaderboard/${user.uid}`).set({
                name: playerName, score: score, level: level, userId: user.uid, date: Date.now()
            }, { merge: true });
        }

        function loadLeaderboard() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'tebak-pisang-freak';
            db.collection(`/artifacts/${appId}/public/data/leaderboard`)
                .onSnapshot(snap => {
                    const list = [];
                    snap.forEach(d => list.push(d.data()));
                    list.sort((a,b) => b.score - a.score);
                    document.getElementById('leaderboard-list').innerHTML = list.slice(0,10).map((u, i) => `
                        <div class="flex justify-between items-center p-4 bg-white border-4 border-black shadow-[5px_5px_0px_#000]">
                            <div class="flex flex-col">
                                <span class="font-bold">${i+1}. ${u.name}</span>
                                <span class="text-[10px] opacity-50">Level: ${u.level || 1}</span>
                            </div>
                            <span class="font-black text-xl">${u.score}</span>
                        </div>
                    `).join('');
                }, () => {});
        }

        window.toggleLeaderboard = () => document.getElementById('leaderboard-box').classList.toggle('hidden');
        function showModal(t, txt, i) {
            document.getElementById('modal-title').innerText = t;
            document.getElementById('modal-text').innerText = txt;
            document.getElementById('modal-icon').innerText = i;
            document.getElementById('message-box').classList.remove('hidden');
        }
        window.closeModal = () => {
            document.getElementById('message-box').classList.add('hidden');
            document.querySelectorAll('.cup, .banana').forEach(el => el.classList.remove('visible', 'lifted'));
        };

        window.onload = initGame;
    </script>
</body>
</html>
